<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Test PAGOS (Gesportin)</title>
    <style>
        body { font-family: sans-serif; padding: 20px; background-color: #f4f4f4; }
        h1 { color: #333; }
        button { margin: 5px; padding: 10px 15px; cursor: pointer; background-color: #007bff; color: white; border: none; border-radius: 4px; font-weight: bold; }
        button:hover { background-color: #0056b3; }
        button.danger { background-color: #dc3545; }
        button.danger:hover { background-color: #a71d2a; }
        .panel { border: 1px solid #ccc; padding: 20px; margin-bottom: 20px; border-radius: 8px; background: #fff; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        input, select { padding: 10px; border-radius: 4px; border: 1px solid #ccc; margin-right: 5px; }
        #log { background: #222; color: #0f0; padding: 15px; border-radius: 5px; white-space: pre-wrap; height: 350px; overflow-y: scroll; font-family: 'Courier New', monospace; font-size: 14px; }
    </style>
</head>
<body>
    <h1>üß™ Testportin: Gesti√≥n de PAGOS</h1>

    <div class="panel">
        <h3>1. Carga Masiva (Backend genera aleatorios)</h3>
        <p>Estos botones llaman a la funci√≥n <code>fill()</code> de Java.</p>
        <button id="btnFill20">Generar 20 Pagos</button>
        <button id="btnEmpty" class="danger">Borrar Todo</button>
        <button id="btnCount">Ver Cantidad (Count)</button>
    </div>

    <div class="panel">
        <h3>2. Editar Estado de Pago</h3>
        <p>Introduce el ID del pago y selecciona si est√° abonado o no.</p>
        <input type="number" id="idToEdit" placeholder="ID del Pago">
        <select id="statusSelect">
            <option value="true">Abonado (S√≠)</option>
            <option value="false">No Abonado (No)</option>
        </select>
        <button id="btnUpdate">Actualizar Estado</button>
    </div>

    <h3>Consola de Resultados:</h3>
    <pre id="log">Sistema listo. Esperando comandos...</pre>

    <script>
        const baseUrl = "http://localhost:8089/pago"; 
        const logEl = document.getElementById("log");

        function log(msg, data = "") {
            const text = typeof data === 'object' ? JSON.stringify(data, null, 2) : data;
            logEl.textContent = `> ${msg} ${text}\n\n` + logEl.textContent;
        }

        async function api(path, method = "GET", body = null) {
            try {
                const options = { method: method, headers: { "Content-Type": "application/json" } };
                if (body) options.body = JSON.stringify(body);
                const res = await fetch(baseUrl + path, options);
                const text = await res.text();
                if (!res.ok) throw { status: res.status, msg: text };
                return text ? JSON.parse(text) : {};
            } catch (err) {
                log("ERROR:", err);
                throw err;
            }
        }

        document.getElementById("btnFill20").addEventListener("click", async () => {
            log("‚è≥ Solicitando al servidor crear 20 pagos...");
            await api("/fill/20", "POST");
            const total = await api("/count", "GET");
            log("‚úÖ ¬°Hecho! Total en base de datos:", total);
        });

        document.getElementById("btnEmpty").addEventListener("click", async () => {
            if(!confirm("¬øBorrar toda la tabla?")) return;
            log("üóëÔ∏è Borrando datos...");
            await api("/empty", "DELETE");
            const total = await api("/count", "GET");
            log("‚úÖ Tabla vac√≠a. Total:", total);
        });

        document.getElementById("btnCount").addEventListener("click", async () => {
            const total = await api("/count", "GET");
            log("üìä Total actual:", total);
        });

        document.getElementById("btnUpdate").addEventListener("click", async () => {
            const id = document.getElementById("idToEdit").value;
            const newStatus = document.getElementById("statusSelect").value === "true";

            if (!id) {
                log("‚ùå Por favor, introduce un ID v√°lido.");
                return;
            }

            try {
                log(`üîç Buscando pago con ID: ${id}...`);
                const pagoActual = await api("/" + id, "GET");

                if (!pagoActual) {
                    log("‚ùå No se encontr√≥ el pago.");
                    return;
                }

                pagoActual.abonado = newStatus;

                log(`üìù Enviando actualizaci√≥n (Abonado: ${newStatus})...`, pagoActual);
                await api("", "PUT", pagoActual);
                
                const pagoVerificado = await api("/" + id, "GET");
                log("‚úÖ Pago actualizado correctamente en BDD:", pagoVerificado);

            } catch (e) {
                log("‚ùå Error al actualizar:", e);
            }
        });
    </script>
</body>
</html>